version: '3.8'

services:
  # ======================
  # VAULTNOTARY BACKEND API
  # ======================
  vaultnotary-api:
    build:
      context: ./backend/src
      dockerfile: VaultNotary.Web/Dockerfile
    container_name: vaultnotary-api
    ports:
      - "5000:80"
    environment:
      - ASPNETCORE_ENVIRONMENT=Test
      - ASPNETCORE_URLS=http://+:80
      - Aws__Region=ap-southeast-1
      - Aws__AccessKey=AKIARXO2YC5AE5JLQIM5
      - Aws__SecretKey=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
      - Aws__DynamoDb__CustomersTableName=VaultNotary-Customers-prod
      - Aws__DynamoDb__DocumentsTableName=VaultNotary-Documents-prod
      - Aws__DynamoDb__PartyDocumentsTableName=VaultNotary-PartyDocuments-prod
      - Aws__S3__BucketName=vaultnotary-files-prod-119107229504
      - Aws__S3__FileKeyPrefix=files/
      - Aws__S3__PresignedUrlExpirationHours=24
      - Aws__Kms__AsymmetricKeyId=357e292d-ba77-4e7f-a879-f2d699148474
      - Aws__Kms__SymmetricKeyId=ef2b40c9-bf0e-46bc-bb66-ff3c962e7ac5
      - ConnectionStrings__RabbitMQ=amqp://admin:password@rabbitmq:5672
    depends_on:
      - rabbitmq
    networks:
      - backend-network
    restart: unless-stopped

  # ======================
  # BACKGROUND JOBS
  # ======================
  vaultnotary-jobs:
    build:
      context: ./backend/src
      dockerfile: VaultNotary.BackgroundJobs/Dockerfile
    container_name: vaultnotary-jobs
    environment:
      - DOTNET_ENVIRONMENT=Test
      - ConnectionStrings__RabbitMQ=amqp://admin:password@rabbitmq:5672
      - Aws__Region=ap-southeast-1
      - Aws__AccessKey=AKIARXO2YC5AHZHJEH73
      - Aws__SecretKey=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
      - Aws__S3__BucketName=vaultnotary-files-prod-119107229504
      - Aws__S3__FileKeyPrefix=files/
      - Aws__Kms__AsymmetricKeyId=357e292d-ba77-4e7f-a879-f2d699148474
      - Aws__Kms__SymmetricKeyId=ef2b40c9-bf0e-46bc-bb66-ff3c962e7ac5
    depends_on:
      - rabbitmq
    networks:
      - backend-network
    restart: unless-stopped

  # ======================
  # FRONTEND (Disabled for API testing)
  # ======================
  # vaultnotary-frontend:
  #   build:
  #     context: ./frontend
  #     dockerfile: Dockerfile
  #   container_name: vaultnotary-frontend
  #   ports:
  #     - "3000:3000"
  #   environment:
  #     - NODE_ENV=development
  #     - NEXT_PUBLIC_API_URL=http://localhost:5000
  #   depends_on:
  #     - vaultnotary-api
  #   networks:
  #     - frontend-network
  #   restart: unless-stopped

  # ======================
  # MESSAGE QUEUE
  # ======================
  rabbitmq:
    image: rabbitmq:3-management-alpine
    container_name: vaultnotary-rabbitmq
    ports:
      - "5672:5672"
      - "15672:15672"
    environment:
      - RABBITMQ_DEFAULT_USER=admin
      - RABBITMQ_DEFAULT_PASS=password
    volumes:
      - rabbitmq-data:/var/lib/rabbitmq
    networks:
      - backend-network
    restart: unless-stopped

# ======================
# NETWORKS
# ======================
networks:
  frontend-network:
    driver: bridge
  backend-network:
    driver: bridge

# ======================
# VOLUMES
# ======================
volumes:
  rabbitmq-data: