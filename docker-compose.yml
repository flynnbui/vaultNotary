version: "3.8"

services:
  # ======================
  # VAULTNOTARY BACKEND API
  # ======================
  vaultnotary-api:
    build:
      context: ./backend/src
      dockerfile: VaultNotary.Web/Dockerfile
    container_name: vaultnotary-api
    ports:
      - "5000:80"
    environment:
      - ASPNETCORE_ENVIRONMENT=Test
      - ASPNETCORE_URLS=http://+:80
      - ConnectionStrings__DefaultConnection=Host=vaultnotary-db-prod.cx0ewaugo94q.ap-southeast-1.rds.amazonaws.com;Port=5432;Database=vaultnotary;Username=vaultnotary_user;Password=CatTu0ng080503
      - Aws__Region=ap-southeast-1
      - Aws__AccessKey=AKIARXO2YC5AHWZKHPIN
      - Aws__SecretKey=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
      - Aws__S3__BucketName=vaultnotary-files-prod-119107229504
      - Aws__S3__FileKeyPrefix=files/
      - Aws__S3__PresignedUrlExpirationHours=24
      - Aws__Kms__SymmetricKeyId=f9998863-7bd3-4682-98cc-cdecc2df87b2
      - ConnectionStrings__RabbitMQ=amqp://admin:password@rabbitmq:5672
    depends_on:
      - rabbitmq
    networks:
      - backend-network
    restart: unless-stopped

  # ======================
  # BACKGROUND JOBS
  # ======================
  # vaultnotary-jobs:
  #   build:
  #     context: ./backend/src
  #     dockerfile: VaultNotary.BackgroundJobs/Dockerfile
  #   container_name: vaultnotary-jobs
  #   environment:
  #     - DOTNET_ENVIRONMENT=Test
  #     - ConnectionStrings__RabbitMQ=amqp://admin:password@rabbitmq:5672
  #     - Aws__Region=us-east-1
  #     - Aws__AccessKey=AKIARXO2YC5AF6QISK4Z
  #     - Aws__SecretKey=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
  #     - Aws__S3__BucketName=vaultnotary-files-dev-119107229504
  #     - Aws__S3__FileKeyPrefix=files/
  #     - Aws__Kms__SymmetricKeyId=f9998863-7bd3-4682-98cc-cdecc2df87b2
  #   depends_on:
  #     - rabbitmq
  #   networks:
  #     - backend-network
  #   restart: unless-stopped

  # ======================
  # FRONTEND (Disabled for API testing)
  # ======================
  # vaultnotary-frontend:
  #   build:
  #     context: ./frontend
  #     dockerfile: Dockerfile
  #   container_name: vaultnotary-frontend
  #   ports:
  #     - "3000:3000"
  #   environment:
  #     - NODE_ENV=development
  #     - NEXT_PUBLIC_API_URL=http://localhost:5000
  #   depends_on:
  #     - vaultnotary-api
  #   networks:
  #     - frontend-network
  #   restart: unless-stopped

  # ======================
  # DATABASE (Disabled for AWS testing)
  # ======================
  # postgres:
  #   image: postgres:15-alpine
  #   container_name: vaultnotary-postgres
  #   ports:
  #     - "5432:5432"
  #   environment:
  #     - POSTGRES_DB=vaultnotary
  #     - POSTGRES_USER=postgres
  #     - POSTGRES_PASSWORD=password
  #   volumes:
  #     - postgres-data:/var/lib/postgresql/data
  #     - ./backend/migrations:/docker-entrypoint-initdb.d
  #   networks:
  #     - backend-network
  #   restart: unless-stopped
  #   healthcheck:
  #     test: ["CMD-SHELL", "pg_isready -U postgres"]
  #     interval: 30s
  #     timeout: 10s
  #     retries: 3

  # ======================
  # MESSAGE QUEUE
  # ======================
  rabbitmq:
    image: rabbitmq:3-management-alpine
    container_name: vaultnotary-rabbitmq
    ports:
      - "5672:5672"
      - "15672:15672"
    environment:
      - RABBITMQ_DEFAULT_USER=admin
      - RABBITMQ_DEFAULT_PASS=password
    volumes:
      - rabbitmq-data:/var/lib/rabbitmq
    networks:
      - backend-network
    restart: unless-stopped

# ======================
# NETWORKS
# ======================
networks:
  frontend-network:
    driver: bridge
  backend-network:
    driver: bridge

# ======================
# VOLUMES
# ======================
volumes:
  postgres-data:
  rabbitmq-data:
